<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Structural Column Schedule (Full Version)</title>
    <style>
        /* ==========================================
           CSS Styling for Column Schedule
           ==========================================
           โครงสร้างหลัก:
           - body: พื้นหลังหน้าเว็บ
           - schedule-container: กล่องคลุมหลัก (พื้นขาว)
           - floor-zone: กล่องคลุมแต่ละโซนชั้น
           - drawing-row: แถวที่ใส่ Story Box + Column Boxes
           - box: กรอบ SVG พื้นฐาน
           - story-box: กล่องแสดงระดับชั้น
           - column-box: กล่องแสดงรายละเอียดเสา
           ========================================== */

        /* ---------- 1. Body & Global ---------- */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            padding: 20px; 
            background-color: #f4f4f4; /* พื้นหลังสีเทาอ่อน */
        }

        /* ---------- 2. Header (H1) ---------- */
        h1 { 
            text-align: center; 
            color: #333; 
            margin-bottom: 30px; 
        }

        /* ---------- 3. Main Container ---------- */
        /* กล่องคลุมหลักทั้งหน้า - พื้นขาว มีเงา */
        .schedule-container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1); /* เงานุ่มๆ */
        }

        /* ---------- 4. Floor Zone (กล่องแต่ละชั้น) ---------- */
        /* กล่องคลุมแต่ละโซน เช่น "Foundation to 1st Floor" */
        .floor-zone {
            margin-bottom: 40px;
            border-bottom: 2px dashed #ccc; /* เส้นแบ่งโซน */
            padding-bottom: 20px;
        }

        /* หัวข้อโซน */
        .zone-title {
            font-size: 20px;
            font-weight: bold;
            color: #444;
            margin-bottom: 15px;
            background-color: #e9ecef; /* พื้นหลังสีเทาอ่อน */
            padding: 10px;
            border-left: 5px solid #007bff; /* แถบสีน้ำเงินซ้าย */
        }

        /* ---------- 5. Drawing Row (แถว SVG) ---------- */
        /* จัดเรียง Story Box + Column Boxes แนวนอน */
        .drawing-row {
            display: flex;
            gap: 15px; /* ระยะห่างระหว่าง Box */
            overflow-x: auto; /* Scroll แนวนอนถ้าเสาเยอะ */
            padding-bottom: 10px;
            align-items: flex-start; /* จัดให้ชิดบน */
        }

        /* ---------- 6. Box (กรอบ SVG พื้นฐาน) ---------- */
        .box {
            border: 1px solid #000;
            background: #fff;
            flex-shrink: 0; /* ห้ามหด ให้ Scroll แทน */
        }

        /* ---------- 7. Story Box (กล่องระดับชั้น) ---------- */
        /* แสดง Top Level / Bottom Level ทางซ้ายสุด */
        .story-box {
            border: 2px solid #000;
            background-color: #fdfdfd;
            position: sticky; /* ติดขอบซ้ายเวลาเลื่อน (Optional) */
            left: 0;
        }

        /* ---------- 8. Column Box (ถ้าต้องการ Style เพิ่ม) ---------- */
        /* ปัจจุบันใช้ .box เป็นพื้นฐาน */
        /* .column-box { } */

    </style>
</head>
<body>

    <h1>Structural Details – Column Schedule</h1>

    <div id="app" class="schedule-container">
        </div>

    <script>
        // ==========================================
        // 1. DATA STRUCTURE (ข้อมูลโครงสร้าง)
        // ==========================================
        /* เราแบ่งข้อมูลเป็น "ชั้นๆ" (Zones)
           ในแต่ละ Zone จะมี "เสา" (Columns) อยู่ข้างใน
        */
        const projectData = [
            
            // --- ZONE 1: Basement ---
            {
                zoneId: "zone-1",
                title: "basement to 1st Floor",
                topLevel: "1st Fl. (+3.00m)",
                bottomLevel: "basement (0.00m)",
                columns: [
                    { name: "C01", height: 2000, width: 250, isSchematic: true },
                    { name: "C02", height: 1200, width: 750, isSchematic: true },
                    { name: "C03", height: 900, width: 750, isSchematic: true },
                    { name: "C04", height: 1200, width: 750, isSchematic: true },
                    { name: "C05", height: 2100, width: 400, isSchematic: true },
                    { name: "C06", height: 2500, width: 450, isSchematic: true },
                ]
            },
            // --- ZONE 0: Foundation ---
            {
                zoneId: "zone-0",
                title: "Foundation to basement",
                topLevel: "basement (0.00m)",
                bottomLevel: "Foundation (-7.50m)",
                columns: [
                    { name: "C01", height: 2000, width: 250, mainBar: "22-DB25", confinementBar: "1-HP-DB10@200", tieBar: "8-RB9@200", extra: "3 WF-100x100", cover: "40mm" },
                    { name: "C02", height: 1200, width: 750, mainBar: "14-DB32", confinementBar: "2-HP-DB12@200", tieBar: "3-DB12@200", extra: "-", cover: "40mm" },
                    { name: "C03", height: 900, width: 750, mainBar: "14-DB28", confinementBar: "2-HP-DB12@200", tieBar: "3-DB9@200", extra: "-", cover: "40mm" },
                    { name: "C04", height: 1200, width: 750, mainBar: "18-DB25", confinementBar: "1-HP-DB12@150", tieBar: "5-RB9@300", extra: "-", cover: "40mm" },
                    { name: "C05", height: 2100, width: 400, mainBar: "24-DB28+4-DB28", confinementBar: "1-HP-DB12@150", tieBar: "7-RB9@300", extra: "4 WF-150X150", cover: "40mm" },
                    { name: "C06", height: 2500, width: 450, mainBar: "20-DB25+4-DB25", confinementBar: "1-HP-DB12@150", tieBar: "7-RB12@300", extra: "4 WF-150X150", cover: "40mm" },
                ]
            }
        ];

        // ==========================================
        // 2. CONFIGURATION (ค่าคงที่สำหรับการวาด)
        // ==========================================
        const CONFIG = {
            startX: 150,     // จุดเริ่มวาด X (ค่าขั้นต่ำสำหรับ StoryBox & คำนวณกึ่งกลาง)
            startY: 150,     // จุดเริ่มวาด Y (เว้นที่ข้างบนให้ชื่อชั้น)
            dimOffset: 40,   // ระยะห่างเส้น Dimension จากเสา
            textPadding: 50, // ระยะห่างตัวหนังสือใต้เสา
            baseSvgHeight: 400 // ความสูงพื้นฐานของ SVG (ไม่รวมความสูงเสา)
        };

        // ==========================================
        // 3. FUNCTIONS (ฟังก์ชันวาด)
        // ==========================================

            // 3.0 ฟังก์ชันวาดเหล็กเสริมใน Elevation View
        function generateRebarElevation(col, startX, startY, uniqueId, isFoundation) {
            let rebarSVG = '';
            
            // ===== Parse ข้อมูลเหล็กจาก string =====
            // Main Bar: รองรับ "12-DB20" หรือ "24-DB28+4-DB28" (จับเฉพาะส่วนแรก + รวมส่วนหลัง + ถ้ามี)
            const mainBarMatch = col.mainBar.match(/(\d+)-DB(\d+)/);
            let mainBarCount = mainBarMatch ? parseInt(mainBarMatch[1]) : 8;
            const mainBarSize = mainBarMatch ? parseInt(mainBarMatch[2]) : 20;
            // รองรับ + notation: เช่น "24-DB28+4-DB28" -> รวมเป็น 28 เส้น
            const plusMatch = col.mainBar.match(/\+(\d+)-DB/);
            if (plusMatch) {
                mainBarCount += parseInt(plusMatch[1]);
            }
            
            // Tie/Stirrup: รองรับ "RB9@100", "3-DB12@200", "7-RB9@300" 
            // Regex ใหม่: จับ @spacing จากท้าย string
            const tieMatch = col.tieBar ? col.tieBar.match(/@(\d+)/) : null;
            const tieSpacing = tieMatch ? parseInt(tieMatch[1]) : 150;
            
            // Confinement Bar: รองรับ "1-HP-DB12@200", "2-HP-DB12@200"
            const confMatch = col.confinementBar ? col.confinementBar.match(/@(\d+)/) : null;
            const confSpacing = confMatch ? parseInt(confMatch[1]) : tieSpacing;
            
            // ===== COVER ระยะหุ้ม =====
            const cover = 15; // ใช้ค่าประมาณ 15px เพื่อความสวยงาม
            
            // ===== วาดเหล็กหลัก (Main Bars) - แนวตั้ง =====
            // สมมติว่าเหล็กหลักอยู่ที่ขอบใกล้ทั้ง 2 ด้าน
            const mainBarRadius = Math.max(mainBarSize / 4, 3); // ความหนาเส้นเหล็กหลัก
            
            // คำนวณจำนวนเหล็กต่อด้าน (สมมติแบ่งครึ่ง)
            const barsPerSide = Math.ceil(mainBarCount / 4); // เหล็กมุม + เหล็กกลาง
            
            // คำนวณความยาวเหล็ก
            // ถ้าเป็นเสา Foundation: ด้านล่างงอฉาก, ด้านบนยื่นต่อ (Dowels)
            // ถ้าเป็นเสาปกติ: ด้านล่างต่อจากชั้นก่อน, ด้านบนยื่นต่อ (Dowels)
            
            // Note: startY คือระดับพื้นชั้นบน (Top Level)
            // ดังนั้นเหล็กต้องยื่นทะลุ startY ขึ้นไป (ค่า Y ลดลง)
            const dowelLength = 40; // ความยาวเหล็กเสียบ (สมมติ)
            const topBarY = startY - dowelLength; 
            
            // เหล็กหลักด้านซ้าย
            const leftX = startX + cover;
            if (isFoundation) {
                // Foundation: งอล่าง, ยื่นบน
                rebarSVG += `<path d="M ${leftX} ${topBarY} L ${leftX} ${startY + col.height - cover} L ${leftX - 20} ${startY + col.height - cover}" 
                             stroke="#DC143C" stroke-width="${mainBarRadius}" fill="none" stroke-linecap="round" stroke-linejoin="round"/>`;
            } else {
                // Normal: ยื่นบน (เพื่อต่อชั้นถัดไป)
                // (จริงๆ ต้องมีด้านล่างด้วย แต่ใน Schedule มักวาดแค่เส้นตรงยาวๆ แทนการทาบ)
                rebarSVG += `<line x1="${leftX}" y1="${topBarY}" x2="${leftX}" y2="${startY + col.height - cover}" 
                             stroke="#DC143C" stroke-width="${mainBarRadius}" stroke-linecap="round"/>`;
            }
            
            // เหล็กหลักด้านขวา
            const rightX = startX + col.width - cover;
            if (isFoundation) {
                // Foundation: งอล่าง, ยื่นบน
                rebarSVG += `<path d="M ${rightX} ${topBarY} L ${rightX} ${startY + col.height - cover} L ${rightX + 20} ${startY + col.height - cover}" 
                             stroke="#DC143C" stroke-width="${mainBarRadius}" fill="none" stroke-linecap="round" stroke-linejoin="round"/>`;
            } else {
                // Normal: ยื่นบน
                rebarSVG += `<line x1="${rightX}" y1="${topBarY}" x2="${rightX}" y2="${startY + col.height - cover}" 
                             stroke="#DC143C" stroke-width="${mainBarRadius}" stroke-linecap="round"/>`;
            }
            
            // เหล็กหลักตรงกลาง (ถ้ามีมากกว่า 4 เส้น)
            if (mainBarCount > 4) {
                const middleBarsCount = Math.min(Math.floor((mainBarCount - 4) / 2), 3);
                const spacing = (col.width - 2 * cover) / (middleBarsCount + 1);
                for (let i = 1; i <= middleBarsCount; i++) {
                    const x = startX + cover + spacing * i;
                    rebarSVG += `<line x1="${x}" y1="${topBarY}" x2="${x}" y2="${startY + col.height - cover}" 
                                 stroke="#DC143C" stroke-width="${mainBarRadius - 1}" stroke-linecap="round" stroke-dasharray="4,2"/>`;
                }
            }
            
            // ===== กำหนด Confinement Zone (ตาม ACI 318) =====
            // Lo = max(h/6, 450mm, max column dimension)
            // สำหรับการแสดงผล ใช้ประมาณ 25% ของความสูงเสา
            const confZoneHeight = Math.max(col.height * 0.25, col.width, 450); // ตาม ACI 318
            const confStrokeWidth = 2;
            const tieStrokeWidth = 2;
            
            // ===== วาดเหล็ก Confinement Zone (หัวเสา) - สีส้ม =====
            if (col.confinementBar) {
                const numConfTop = Math.max(Math.floor(confZoneHeight / confSpacing), 2);
                const confScaledSpacing = confZoneHeight / (numConfTop + 1);
                
                for (let i = 0; i <= numConfTop; i++) {
                    const confY = startY + cover + confScaledSpacing * i;
                    // เส้นปลอกแนวนอน
                    rebarSVG += `<line x1="${startX + cover - 5}" y1="${confY}" x2="${startX + col.width - cover + 5}" y2="${confY}" 
                                 stroke="#8B008B" stroke-width="${confStrokeWidth}"/>`;
                    // Tick mark ที่ปลายทั้ง 2 ด้าน
                    rebarSVG += `<line x1="${startX + cover - 5}" y1="${confY - 4}" x2="${startX + cover - 5}" y2="${confY + 4}" 
                                 stroke="#8B008B" stroke-width="${confStrokeWidth}"/>`;
                    rebarSVG += `<line x1="${startX + col.width - cover + 5}" y1="${confY - 4}" x2="${startX + col.width - cover + 5}" y2="${confY + 4}" 
                                 stroke="#8B008B" stroke-width="${confStrokeWidth}"/>`;
                }
                
                // ===== วาดเหล็ก Confinement Zone (ท้ายเสา) - สีส้ม =====
                for (let i = 0; i <= numConfTop; i++) {
                    const confY = startY + col.height - cover - confScaledSpacing * i;
                    // เส้นปลอกแนวนอน
                    rebarSVG += `<line x1="${startX + cover - 5}" y1="${confY}" x2="${startX + col.width - cover + 5}" y2="${confY}" 
                                 stroke="#8B008B" stroke-width="${confStrokeWidth}"/>`;
                    // Tick mark ที่ปลายทั้ง 2 ด้าน
                    rebarSVG += `<line x1="${startX + cover - 5}" y1="${confY - 4}" x2="${startX + cover - 5}" y2="${confY + 4}" 
                                 stroke="#8B008B" stroke-width="${confStrokeWidth}"/>`;
                    rebarSVG += `<line x1="${startX + col.width - cover + 5}" y1="${confY - 4}" x2="${startX + col.width - cover + 5}" y2="${confY + 4}" 
                                 stroke="#8B008B" stroke-width="${confStrokeWidth}"/>`;
                }
            }
            
            // ===== วาดเหล็กปลอก Normal Zone (กลางเสา) - สีน้ำเงิน =====
            const normalZoneStart = startY + cover + confZoneHeight;
            const normalZoneEnd = startY + col.height - cover - confZoneHeight;
            const normalZoneHeight = normalZoneEnd - normalZoneStart;
            
            if (normalZoneHeight > 0) {
                const numTies = Math.max(Math.floor(normalZoneHeight / tieSpacing), 1);
                const scaledSpacing = normalZoneHeight / (numTies + 1);
                
                for (let i = 1; i <= numTies; i++) {
                    const tieY = normalZoneStart + scaledSpacing * i;
                    // เส้นปลอกแนวนอน
                    rebarSVG += `<line x1="${startX + cover - 5}" y1="${tieY}" x2="${startX + col.width - cover + 5}" y2="${tieY}" 
                                 stroke="#4169E1" stroke-width="${tieStrokeWidth}"/>`;
                    // Tick mark ที่ปลายทั้ง 2 ด้าน
                    rebarSVG += `<line x1="${startX + cover - 5}" y1="${tieY - 4}" x2="${startX + cover - 5}" y2="${tieY + 4}" 
                                 stroke="#4169E1" stroke-width="${tieStrokeWidth}"/>`;
                    rebarSVG += `<line x1="${startX + col.width - cover + 5}" y1="${tieY - 4}" x2="${startX + col.width - cover + 5}" y2="${tieY + 4}" 
                                 stroke="#4169E1" stroke-width="${tieStrokeWidth}"/>`;
                }
            }
            
            // ===== เหล็กปลอกบนสุดและล่างสุด =====
            const topTieY = startY + cover;
            const bottomTieY = startY + col.height - cover;
            
            rebarSVG += `<line x1="${startX + cover - 5}" y1="${topTieY}" x2="${startX + col.width - cover + 5}" y2="${topTieY}" 
                         stroke="#4169E1" stroke-width="${tieStrokeWidth}"/>`;
            rebarSVG += `<line x1="${startX + cover - 5}" y1="${bottomTieY}" x2="${startX + col.width - cover + 5}" y2="${bottomTieY}" 
                         stroke="#4169E1" stroke-width="${tieStrokeWidth}"/>`;
            
            // ===== เพิ่ม Dimension Bar ด้านขวา (Rebar Spacing) =====
            const dimX = startX + col.width + 30; // ขยับออกมาทางขวา 30px
            const dimColor = "red"; // ใช้สีแดงตามเสา
            const dimFontSize = 18; // ขนาดฟอนต์ตามเสา
            
            // Note: ใช้ marker-start และ marker-end ที่มีอยู่แล้ว (uniqueId)
            
            // 1. Dimension - Confinement Top
            const confTopY = startY + cover + confZoneHeight;
            rebarSVG += `
                <g stroke="${dimColor}" stroke-width="2">
                    <!-- เส้นบอกระยะ -->
                    <line x1="${dimX}" y1="${startY}" x2="${dimX}" y2="${confTopY}" marker-start="url(#${uniqueId})" marker-end="url(#${uniqueId})" />
                    <!-- เส้น Extension line แนวนอน -->
                    <line x1="${startX + col.width}" y1="${startY}" x2="${dimX + 10}" y2="${startY}" stroke-width="1" stroke-dasharray="4,2" />
                    <line x1="${startX + col.width}" y1="${confTopY}" x2="${dimX + 10}" y2="${confTopY}" stroke-width="1" stroke-dasharray="4,2" />
                    <!-- ข้อความ -->
                    <text x="${dimX + 15}" y="${startY + confZoneHeight/2}" fill="${dimColor}" font-size="${dimFontSize}" dominant-baseline="middle" text-anchor="start">
                        Conf. @${confSpacing}
                    </text>
                </g>
            `;
            
            // 2. Dimension - Normal Zone (Middle)
            const normalStart = confTopY;
            const normalEnd = startY + col.height - cover - confZoneHeight;
            
            // ป้องกันกรณีทับซ้อนถ้า Normal Zone เล็กมาก
            if (normalEnd > normalStart) {
                 rebarSVG += `
                    <g stroke="${dimColor}" stroke-width="2">
                        <line x1="${dimX}" y1="${normalStart}" x2="${dimX}" y2="${normalEnd}" marker-start="url(#${uniqueId})" marker-end="url(#${uniqueId})" />
                        <line x1="${startX + col.width}" y1="${normalEnd}" x2="${dimX + 10}" y2="${normalEnd}" stroke-width="1" stroke-dasharray="4,2" />
                        <text x="${dimX + 15}" y="${normalStart + (normalEnd-normalStart)/2}" fill="${dimColor}" font-size="${dimFontSize}" dominant-baseline="middle" text-anchor="start">
                            Tie @${tieSpacing}
                        </text>
                    </g>
                `;
            }

            // 3. Dimension - Confinement Bottom
            const confBotStart = normalEnd;
            const confBotEnd = startY + col.height;
            rebarSVG += `
                <g stroke="${dimColor}" stroke-width="2">
                    <line x1="${dimX}" y1="${confBotStart}" x2="${dimX}" y2="${confBotEnd}" marker-start="url(#${uniqueId})" marker-end="url(#${uniqueId})" />
                    <line x1="${startX + col.width}" y1="${confBotEnd}" x2="${dimX + 10}" y2="${confBotEnd}" stroke-width="1" stroke-dasharray="4,2" />
                    <text x="${dimX + 15}" y="${confBotStart + (confBotEnd-confBotStart)/2}" fill="${dimColor}" font-size="${dimFontSize}" dominant-baseline="middle" text-anchor="start">
                        Conf. @${confSpacing}
                    </text>
                </g>
            `;

            return rebarSVG;
        }

        // 3.0.1 ฟังก์ชันวาด Section View (รูปตัดขวาง)
        function generateSectionView(col, startX, startY) {
            let sectionSVG = '';
            const cover = 40; // Cover จริง 40mm (Scale 1px=1mm ไปเลยเพื่อง่าย)
            
            // 1. วาด Concrete Outline (ใช้วงกลมนิดๆ ให้ดูมนสมจริงงานเขียนแบบ)
            sectionSVG += `<rect x="${startX}" y="${startY}" width="${col.width}" height="${col.width}" 
                           fill="#f0f0f0" stroke="black" stroke-width="4" rx="5" ry="5"/>`;

            // 2. วาด Stirrup (เหล็กปลอก) - Outline ด้านใน
            const tieX = startX + cover;
            const tieY = startY + cover;
            const tieSize = col.width - (2 * cover);
            
            // ปลอกเดี่ยว (Single Tie)
            sectionSVG += `<rect x="${tieX}" y="${tieY}" width="${tieSize}" height="${tieSize}" 
                           fill="none" stroke="#4169E1" stroke-width="3" rx="5" ry="5"/>`;
                           
            // Hook ของปลอก (135 องศา - แบบง่าย)
            sectionSVG += `<path d="M ${tieX + 10} ${tieY + 10} L ${tieX - 5} ${tieY - 5}" stroke="#4169E1" stroke-width="3"/>`;
            sectionSVG += `<path d="M ${tieX + 10} ${tieY + 20} L ${tieX + 20} ${tieY + 10}" stroke="#4169E1" stroke-width="3"/>`;

            // 3. วาด Main Bars (จุดวงกลม)
            // Parse ข้อมูล
            const mainBarMatch = col.mainBar.match(/(\d+)-DB(\d+)/);
            const numBars = mainBarMatch ? parseInt(mainBarMatch[1]) : 8;
            const barSize = mainBarMatch ? parseInt(mainBarMatch[2]) : 20;
            const barRadius = Math.max(barSize / 2, 4); // รัศมีวงกลมเหล็กในรูปตัด
            
            // คำนวณตำแหน่งเหล็ก
            // 4 มุมเสมอ
            const corners = [
                {x: tieX, y: tieY}, // Top-Left
                {x: tieX + tieSize, y: tieY}, // Top-Right
                {x: tieX + tieSize, y: tieY + tieSize}, // Bottom-Right
                {x: tieX, y: tieY + tieSize} // Bottom-Left
            ];
            
            // วาดเหล็กมุม 4 เส้น
            corners.forEach(p => {
                sectionSVG += `<circle cx="${p.x}" cy="${p.y}" r="${barRadius}" fill="#DC143C" stroke="black" stroke-width="1"/>`;
            });
            
            // เหล็กข้าง (Side bars)
            if (numBars > 4) {
                const remainingBars = numBars - 4;
                const barsPerSide = remainingBars / 4; // สมมติกระจายเท่ากัน 4 ด้าน (เบื้องต้น)
                // ตรวจสอบว่าหารลงตัวไหม ถ้าไม่ลงอาจจะต้อง logic ซับซ้อนกว่านี้ (เอาแบบง่ายก่อนนะ)
                const perSideInt = Math.ceil(barsPerSide); 
                
                // ระยะห่างระหว่างเหล็กแกน
                const spacing = tieSize / (perSideInt + 1);
                
                // Top & Bottom Sides
                for(let i=1; i<=perSideInt; i++) {
                     // Top
                     sectionSVG += `<circle cx="${tieX + spacing*i}" cy="${tieY}" r="${barRadius}" fill="#DC143C" stroke="black" stroke-width="1"/>`;
                     // Bottom
                     sectionSVG += `<circle cx="${tieX + spacing*i}" cy="${tieY + tieSize}" r="${barRadius}" fill="#DC143C" stroke="black" stroke-width="1"/>`;
                     // Left
                     sectionSVG += `<circle cx="${tieX}" cy="${tieY + spacing*i}" r="${barRadius}" fill="#DC143C" stroke="black" stroke-width="1"/>`;
                     // Right
                     sectionSVG += `<circle cx="${tieX + tieSize}" cy="${tieY + spacing*i}" r="${barRadius}" fill="#DC143C" stroke="black" stroke-width="1"/>`;
                }
            }
            
            // 4. ข้อความ SECTION A-A
            sectionSVG += `<text x="${startX + col.width/2}" y="${startY + col.width + 50}" 
                           font-size="24" fill="black" font-weight="bold" text-anchor="middle" text-decoration="underline">SECTION A-A</text>`;

            // 5. Dimension รอบรูปตัด (Dimensions for Section View)
            const dimOffset = 30;
            const tickSize = 5; // ความยาวเส้นขีดมิติ
            const dimColor = "red";
            
            // 5.1 Horizontal Dimension (Top)
            const dimY_top = startY - dimOffset;
            sectionSVG += `
                <g stroke="${dimColor}" stroke-width="1">
                    <line x1="${startX}" y1="${dimY_top}" x2="${startX + col.width}" y2="${dimY_top}" marker-start="url(#tick-dim)" marker-end="url(#tick-dim)"/>
                    <line x1="${startX}" y1="${startY}" x2="${startX}" y2="${dimY_top - tickSize}" />
                    <line x1="${startX + col.width}" y1="${startY}" x2="${startX + col.width}" y2="${dimY_top - tickSize}" />
                    <text x="${startX + col.width/2}" y="${dimY_top - 8}" fill="${dimColor}" font-size="16" text-anchor="middle">${col.width}</text>
                </g>
            `;
            
            // 5.2 Vertical Dimension (Left)
            const dimX_left = startX - dimOffset;
            sectionSVG += `
                <g stroke="${dimColor}" stroke-width="1">
                    <line x1="${dimX_left}" y1="${startY}" x2="${dimX_left}" y2="${startY + col.width}" marker-start="url(#tick-dim)" marker-end="url(#tick-dim)"/>
                    <line x1="${startX}" y1="${startY}" x2="${dimX_left - tickSize}" y2="${startY}" />
                    <line x1="${startX}" y1="${startY + col.width}" x2="${dimX_left - tickSize}" y2="${startY + col.width}" />
                    
                    <text x="${dimX_left - 8}" y="${startY + col.width/2}" fill="${dimColor}" font-size="16" text-anchor="middle" transform="rotate(-90, ${dimX_left - 8}, ${startY + col.width/2})">${col.width}</text>
                </g>
            `;

            return sectionSVG;
        }

        // 3.1 ฟังก์ชันสร้าง Story Box (บอกระดับชั้น)
        function generateStoryBox(topText, bottomText, height, viewHeight) {
            const { startY } = CONFIG;
            // ระยะห่างระหว่าง Text บน กับ Line บน = startY(150) - 50 = 100
            const spacing = startY - 50; 
            
            // Text ล่างอยู่ตำแหน่ง viewHeight - 50 (เผื่อขอบล่าง 50)
            const bottomTextY = viewHeight - 50;
            // Line ล่างจึงควรอยู่เหนือ Text ขึ้นมา 100 เท่ากัน
            const bottomLineY = bottomTextY - spacing;

            return `
                <div class="box story-box">
                    <svg width="250" height="${viewHeight}" xmlns="http://www.w3.org/2000/svg">
                        <text x="125" y="50" font-size="24" fill="blue" font-weight="bold" text-anchor="middle">${topText}</text>
                        <line x1="20" y1="${startY}" x2="230" y2="${startY}" stroke="blue" stroke-width="2" stroke-dasharray="10,5"/>

                        <text x="125" y="${bottomTextY}" font-size="24" fill="blue" font-weight="bold" text-anchor="middle">${bottomText}</text>
                        <line x1="20" y1="${bottomLineY}" x2="230" y2="${bottomLineY}" stroke="blue" stroke-width="2" stroke-dasharray="10,5"/>
                    </svg>
                </div>
            `;
        }

        // 3.2 ฟังก์ชันสร้าง Column Box (วาดเสา + Dimensions + Section)
        function generateColumnSVG(col, isFoundation = false, viewHeight, svgWidth) {
            const { dimOffset, textPadding } = CONFIG; // เอา startX และ startY ออกจาก CONFIG
            
            // คำนวณ startX ให้เสาอยู่ตรงกลาง Box (Center Align)
            // แต่ต้องไม่น้อยกว่า 150 (CONFIG.startX เดิม) เพื่อให้มีที่เหลือสำหรับ Dimension ด้านซ้าย
            const calculatedStartX = (svgWidth - col.width) / 2;
            const startX = Math.max(calculatedStartX, 150);
            
            // คำนวณ startY แบบ Bottom-Aligned
            // Content Height = dim(100) + elevation title(50) + col.height + labels(~160) + section offset(220) + section view(col.width + 100)
            const contentHeight = 100 + col.height + 160 + 220 + col.width + 100;
            const bottomMargin = 50; // เผื่อขอบล่าง
            const topMargin = 100; // เผื่อขอบบน (สำหรับชื่อเสา + dimension)
            // startY = ตำแหน่งที่ทำให้ Content ชิดล่าง
            const startY = Math.max(viewHeight - contentHeight - bottomMargin + 100, topMargin);
            
            const uniqueId = `tick-${col.name}-${Math.floor(Math.random() * 1000)}`;
            
            // ===== CASE 1: เสาหยุด (Terminated) =====
            if (col.isTerminated) {
                 // ใช้ viewHeight/2 เป็นกึ่งกลางตายตัว เพื่อให้ทุกเสาอยู่ตำแหน่งเดียวกัน
                 const centerY = viewHeight / 2;

                 return `
                    <div class="box column-box">
                        <svg width="${svgWidth}" height="${viewHeight}" xmlns="http://www.w3.org/2000/svg">
                            <!-- ชื่อเสา - ใช้ svgWidth/2 เพื่อให้อยู่กลาง Box จริงๆ -->
                            <text x="${svgWidth/2}" y="50" font-size="32" fill="red" font-weight="bold" text-anchor="middle">${col.name}</text>
                            
                            <!-- สัญลักษณ์เสาหยุด (Flat Rectangle) -->
                            <!-- วางไว้ตรงกลาง Box -->
                            <rect x="${svgWidth/2 - col.width/2}" y="${centerY - 10}" width="${col.width}" height="20" 
                                  fill="none" stroke="black" stroke-width="2"/>
                                  
                            <!-- Optional: Text บอกสถานะ -->
                             <text x="${svgWidth/2}" y="${centerY + 40}" font-size="16" fill="#666" text-anchor="middle">(Terminated)</text>
                        </svg>
                    </div>
                `;
            }

            // ===== CASE 2: เสาแบบย่อ (Schematic / Arrow) =====
            if (col.isSchematic) {
                 // ใช้ viewHeight/2 เป็นกึ่งกลางตายตัว เพื่อให้ทุกเสาอยู่ตำแหน่งเดียวกัน
                 const centerY = viewHeight / 2;
                 return `
                    <div class="box column-box">
                        <svg width="${svgWidth}" height="${viewHeight}" xmlns="http://www.w3.org/2000/svg">
                            <!-- ชื่อเสา -->
                            <text x="${svgWidth/2}" y="50" font-size="32" fill="red" font-weight="bold" text-anchor="middle">${col.name}</text>
                            
                            <!-- ลูกศรชี้ขึ้น (Arrow) -->
                            <!-- ใช้ viewHeight/2 เป็นกึ่งกลาง -->
                            <g transform="translate(${svgWidth/2}, ${centerY}) scale(2)">
                                <path d="M 0 -20 L 0 20 M -10 -10 L 0 -20 L 10 -10" 
                                      stroke="#333" stroke-width="2" fill="none" />
                            </g>
                            
                             <!-- Text บอกความหมาย -->
                             <text x="${svgWidth/2}" y="${centerY + 60}" font-size="16" fill="#666" text-anchor="middle">Typical</text>
                        </svg>
                    </div>
                `;
            }

            // ===== CASE 3: เสาปกติ (Normal) =====
            return `
                <div class="box column-box">
                    <svg width="${svgWidth}" height="${viewHeight}" xmlns="http://www.w3.org/2000/svg">
                        
                        <defs>
                            <marker id="${uniqueId}" markerWidth="12" markerHeight="12" refX="6" refY="6" orient="auto">
                                <line x1="2" y1="10" x2="10" y2="2" stroke="red" stroke-width="2" />
                            </marker>
                            <!-- Global Marker for Section Dimensions (ถ้ายังไม่มี) -->
                            <marker id="tick-dim" markerWidth="12" markerHeight="12" refX="6" refY="6" orient="auto">
                                <line x1="2" y1="10" x2="10" y2="2" stroke="red" stroke-width="2" />
                            </marker>
                        </defs>

                        <text x="${startX + col.width/2}" y="50" font-size="32" fill="red" font-weight="bold" text-anchor="middle">${col.name}</text>

                        <rect x="${startX}" y="${startY}" width="${col.width}" height="${col.height}" 
                              fill="none" stroke="black" stroke-width="4"/>

                        <!-- ====== REBAR IN ELEVATION VIEW ====== -->
                        ${generateRebarElevation(col, startX, startY, uniqueId, isFoundation)}

                        <g stroke="red" stroke-width="2">
                            <line x1="${startX}" y1="${startY}" x2="${startX}" y2="${startY - dimOffset - 15}" stroke-width="1"/>
                            <line x1="${startX + col.width}" y1="${startY}" x2="${startX + col.width}" y2="${startY - dimOffset - 15}" stroke-width="1"/>
                            <line x1="${startX}" y1="${startY - dimOffset}" x2="${startX + col.width}" y2="${startY - dimOffset}"
                                  marker-start="url(#${uniqueId})" marker-end="url(#${uniqueId})"/>
                            <text x="${startX + col.width/2}" y="${startY - dimOffset - 10}" font-size="18" fill="red" text-anchor="middle">${col.width}</text>
                        </g>

                        <g stroke="red" stroke-width="2">
                            <line x1="${startX}" y1="${startY}" x2="${startX - dimOffset - 15}" y2="${startY}" stroke-width="1"/>
                            <line x1="${startX}" y1="${startY + col.height}" x2="${startX - dimOffset - 15}" y2="${startY + col.height}" stroke-width="1"/>
                            <line x1="${startX - dimOffset}" y1="${startY}" x2="${startX - dimOffset}" y2="${startY + col.height}"
                                  marker-start="url(#${uniqueId})" marker-end="url(#${uniqueId})"/>
                            <text x="${startX - dimOffset - 15}" y="${startY + col.height/2}" font-size="18" fill="red" text-anchor="middle"
                                  transform="rotate(-90, ${startX - dimOffset - 15}, ${startY + col.height/2})">${col.height}</text>
                        </g>

                        <g font-size="18" fill="#333" font-family="monospace">
                            <text x="${startX}" y="${startY + col.height + textPadding}">MAIN : ${col.mainBar}</text>
                            <text x="${startX}" y="${startY + col.height + textPadding + 25}">CONFINEMENT BAR : ${col.confinementBar}</text>
                            <text x="${startX}" y="${startY + col.height + textPadding + 50}">TIE  : ${col.tieBar}</text>
                            <text x="${startX}" y="${startY + col.height + textPadding + 75}">EXTRA : ${col.extra}</text>
                            <text x="${startX}" y="${startY + col.height + textPadding + 100}">COVER : ${col.cover}</text>
                        </g>

                        <!-- View Title (Elevation) -->
                        <text x="${startX + col.width/2}" y="${startY + col.height + textPadding + 160}" 
                              font-size="24" fill="black" font-weight="bold" text-anchor="middle" text-decoration="underline">ELEVATION VIEW</text>

                         <!-- ====== SECTION VIEW ====== -->
                         <!-- วาด Section ต่อท้ายด้านล่าง -->
                         ${generateSectionView(col, startX, startY + col.height + textPadding + 220)}

                    </svg>
                </div>
            `;
        }

        // ==========================================
        // 4. MAIN EXECUTION (ประมวลผล)
        // ==========================================
        const appContainer = document.getElementById('app');
        let fullContentHTML = "";

        // ===== คำนวณความกว้างเสาสูงสุดจากทุก Zone (เพื่อให้ทุก Box มีความกว้างเท่ากัน) =====
        let globalMaxColumnWidth = 0;
        projectData.forEach(zone => {
            zone.columns.forEach(col => {
                if (col.width > globalMaxColumnWidth) globalMaxColumnWidth = col.width;
            });
        });
        const unifiedSvgWidth = Math.max(CONFIG.startX + globalMaxColumnWidth + 250, 600);

        // วนลูปทีละ "โซนชั้น" (Zone)
        projectData.forEach(zone => {
            
            // 4.1 หาความสูงเสาสูงสุดของ Zone นี้ (เผื่อเสาความสูงไม่เท่ากัน)
            let maxColumnHeight = 0;
            zone.columns.forEach(c => {
                if (c.height > maxColumnHeight) maxColumnHeight = c.height;
            });
            
            // คำนวณความสูงรวมทั้งหมด (Max Height + Base + Max Section Height)
            // หาความสูง Section ที่มากที่สุดใน Zone นี้ (เผื่อเสาขนาดไม่เท่ากัน หรือเป็นเสาหยุด/Schematic)
            let maxSectionHeight = 0;
            zone.columns.forEach(c => {
                 if (!c.isTerminated && !c.isSchematic) { // คำนวณเฉพาะเสาที่มี Section
                     const currentSecH = c.width + 200; // เพิ่ม padding สำหรับ dimension และ label
                     if(currentSecH > maxSectionHeight) maxSectionHeight = currentSecH;
                 }
            });
            // ใช้ความสูงเสาสูงสุด + padding + Section Height
            const totalViewHeight = Math.max(maxColumnHeight + CONFIG.baseSvgHeight + maxSectionHeight, 600);

            // 4.2 สร้าง HTML ส่วนหัวของ Zone
            fullContentHTML += `
                <div class="floor-zone">
                    <div class="zone-title">${zone.title}</div>
                    <div class="drawing-row">
            `;

            // 4.3 ใส่ Story Box (ซ้ายสุด)
            fullContentHTML += generateStoryBox(zone.topLevel, zone.bottomLevel, maxColumnHeight, totalViewHeight);

            // 4.4 วนลูปใส่เสา (Columns)
            zone.columns.forEach(col => {
                // เช็คว่าเป็น Zone Foundation หรือไม่ (Zone-0)
                const isFoundation = (zone.zoneId === "zone-0");
                fullContentHTML += generateColumnSVG(col, isFoundation, totalViewHeight, unifiedSvgWidth);
            });

            // ปิด Tag ของ Zone
            fullContentHTML += `
                    </div>
                </div>
            `;
        });

        // แสดงผลลัพธ์
        appContainer.innerHTML = fullContentHTML;

    </script>
</body>
</html>