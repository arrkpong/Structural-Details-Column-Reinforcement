<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Structural Detail - Column Reinforcement</title>
    <style>
        :root {
            --blueprint-bg: #0a244d;
            --blueprint-grid: #1c3b6b;
            --drawing-white: #ffffff;
            --drawing-yellow: #ffeb3b;
            --sidebar-bg: #f4f4f4;
            --sidebar-text: #333;
        }
        
        body {
            background-color: var(--blueprint-bg);
            margin: 0;
            padding: 0;
            font-family: 'Courier New', Courier, monospace; /* Font แบบพิมพ์เขียว */
            color: var(--drawing-white);
            height: 100vh;
            display: flex; /* ใช้ Flexbox สำหรับ Layout หลัก */
            overflow: hidden;
        }

        /* --- Sidebar Styles --- */
        .sidebar {
            width: 350px;
            background-color: var(--sidebar-bg);
            color: var(--sidebar-text);
            padding: 20px;
            overflow-y: auto;
            box-shadow: 2px 0 5px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            gap: 15px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* Font อ่านง่ายสำหรับ UI */
        }

        .sidebar h2 { margin-top: 0; border-bottom: 2px solid #ddd; padding-bottom: 10px; font-size: 1.2rem; }
        .form-group { display: flex; flex-direction: column; gap: 5px; margin-bottom: 10px; }
        .form-group label { font-size: 0.9rem; font-weight: 600; }
        .form-group input, .form-group select { 
            padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9rem; 
        }
        .form-row { display: flex; gap: 10px; }
        .form-row .form-group { flex: 1; }
        
        .section-header {
            background: #e0e0e0;
            padding: 5px 10px;
            font-weight: bold;
            margin: 10px -20px 5px -20px; /* เต็มขอบ */
        }

        /* --- Drawing Area Styles --- */
        .drawing-container {
            flex: 1; /* กินพื้นที่ที่เหลือ */
            position: relative;
            background-image: 
                linear-gradient(var(--blueprint-grid) 1px, transparent 1px),
                linear-gradient(90deg, var(--blueprint-grid) 1px, transparent 1px);
            background-size: 40px 40px; /* Grid size */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .viewport {
            width: 95%;
            height: 95%;
        }

        svg {
            width: 100%;
            height: 100%;
            /* border: 1px solid rgba(255, 255, 255, 0.2); Debug border */
        }

        /* SVG Elements Styling */
        .concrete-outline { fill: none; stroke: white; stroke-width: 2; }
        .stirrup { fill: none; stroke: var(--drawing-yellow); stroke-width: 2; }
        .main-bar { fill: white; stroke: none; }
        .dim-line { stroke: white; stroke-width: 0.5; }
        .label-text { fill: white; font-size: 14px; font-weight: bold; }
        .sub-label { fill: #aaaaaa; font-size: 12px; }
        .view-title { font-size: 20px; font-weight: bold; text-decoration: underline; fill: var(--drawing-white); }

        .title-block-container {
            position: absolute;
            bottom: 20px;
            right: 40px;
            z-index: 10;
        }

        .title-block {
            border: 2px solid white;
            padding: 15px;
            background: rgba(10, 36, 77, 0.9);
            width: 300px;
            font-size: 12px;
        }
        
        .tb-row { display: flex; margin-bottom: 5px; }
        .tb-label { font-weight: bold; width: 80px; flex-shrink: 0; }
        .tb-value { flex-grow: 1; }
        .tb-project { font-size: 14px; font-weight: bold; color: var(--drawing-yellow); margin-bottom: 10px; border-bottom: 1px solid white; padding-bottom: 5px; }

        /* Export Button Styles */
        .export-btn {
            width: 100%;
            padding: 12px 20px;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .export-btn.svg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .export-btn.svg:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46a0 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

    </style>
</head>
<body>

    <!-- Sidebar Control Panel -->
    <div class="sidebar">
        <h2>Edit</h2>
        
        <div class="section-header">Title</div>
        <div class="form-group">
            <label>Project Name</label>
            <input type="text" id="inp-project" value="CIVIL PARK INTERNATIONAL">
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Dwg Title</label>
                <input type="text" id="inp-title-val" value="COLUMN C1">
            </div>
            <div class="form-group">
                <label>Date</label>
                <input type="text" id="inp-date-val" value="18/12/2025">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Drawn By</label>
                <input type="text" id="inp-drawn-val" value="arrkpong jerosiri">
            </div>
            <div class="form-group">
                <label>Scale</label>
                <input type="text" id="inp-scale-val" value="N.T.S.">
            </div>
        </div>
        <div class="form-group">
            <label>Note Suffix</label>
            <input type="text" id="inp-note-val" value="ARRANGED ALONG BOUNDARY.">
        </div>

        <div class="section-header">Dimensions (mm)</div>
        <div class="form-row">
            <div class="form-group">
                <label>Width (Bx)</label>
                <input type="number" id="inp-width" value="600" step="50">
            </div>
            <div class="form-group">
                <label>Depth (By)</label>
                <input type="number" id="inp-depth" value="600" step="50">
            </div>
        </div>
        <div class="form-group">
            <label>Cover</label>
            <input type="number" id="inp-cover" value="40">
        </div>

        <div class="section-header">Main Bars (เหล็กยืน)</div>
        <div class="form-row">
            <div class="form-group">
                <label>Info</label>
                <input type="text" id="inp-main-size" value="DB25">
            </div>
            <div class="form-group">
                <label>Total Count</label>
                <input type="number" id="inp-main-count" value="16" readonly title="Calculated from X/Y">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Bars X-Dir</label>
                <input type="number" id="inp-nx" value="5" min="2">
            </div>
            <div class="form-group">
                <label>Bars Y-Dir</label>
                <input type="number" id="inp-ny" value="5" min="2">
            </div>
        </div>

        <div class="section-header">Stirrups (เหล็กปลอก)</div>
        <div class="form-group">
            <label>Size</label>
            <input type="text" id="inp-tie-size" value="DB10">
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Spacing Zone</label>
                <input type="number" id="inp-s-zone" value="75">
            </div>
            <div class="form-group">
                <label>Spacing Mid</label>
                <input type="number" id="inp-s-mid" value="200">
            </div>
        </div>

        <div class="section-header">Export</div>
        <button class="export-btn svg" onclick="exportSVG()">
            Export SVG
        </button>
    </div>

    <!-- Drawing Area -->
    <div class="drawing-container">
        <div class="viewport">
            <svg id="main-svg" viewBox="-100 -50 1400 700" preserveAspectRatio="xMidYMid meet">
                <!-- Content will be generated by JS -->
            </svg>
        </div>

        <div class="title-block-container">
            <div class="title-block">
                <div class="tb-project"><span id="lbl-project">PROJECT</span>: <span id="tb-project">...</span></div>
                <div class="tb-row">
                    <span class="tb-label"><span id="lbl-title">DWG TITLE</span>:</span>
                    <span class="tb-value" id="tb-title">...</span>
                </div>
                <div class="tb-row">
                    <span class="tb-label">DATE:</span>
                    <span class="tb-value" id="tb-date">...</span>
                </div>
                <div class="tb-row">
                    <span class="tb-label"><span id="lbl-drawn">DRAWN BY</span>:</span>
                    <span class="tb-value" id="tb-drawn-val">...</span>
                </div>
                <div class="tb-row">
                    <span class="tb-label">SCALE:</span>
                    <span class="tb-value" id="tb-scale">...</span>
                </div>
                <div class="tb-row">
                    <span class="tb-label"><span id="lbl-note">NOTE</span>:</span>
                    <span class="tb-value" id="tb-note">...</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration & State ---
        const svg = document.getElementById('main-svg');
        const state = {
            project: '', colName: '', engineer: '',
            width: 0, depth: 0, cover: 0,
            mainSize: '', nx: 0, ny: 0,
            tieSize: '', sZone: 0, sMid: 0
        };

        // --- DOM Elements ---
        const inputs = {
            project: document.getElementById('inp-project'),
            width: document.getElementById('inp-width'),
            depth: document.getElementById('inp-depth'),
            cover: document.getElementById('inp-cover'),
            mainSize: document.getElementById('inp-main-size'),
            nx: document.getElementById('inp-nx'),
            ny: document.getElementById('inp-ny'),
            tieSize: document.getElementById('inp-tie-size'),
            sZone: document.getElementById('inp-s-zone'),
            sMid: document.getElementById('inp-s-mid'),
            mainCountDisplay: document.getElementById('inp-main-count'),
            // Inputs for Values
            titleVal: document.getElementById('inp-title-val'),
            dateVal: document.getElementById('inp-date-val'),
            drawnVal: document.getElementById('inp-drawn-val'),
            scaleVal: document.getElementById('inp-scale-val'),
            noteVal: document.getElementById('inp-note-val')
        };

        // --- Initialization ---
        function init() {
            // Attach event listeners
            Object.values(inputs).forEach(inp => {
                if(inp) inp.addEventListener('input', updateDrawing);
            });
            updateDrawing();
        }

        // --- Main Update Function ---
        function updateDrawing() {
            try {
                // 1. Read Inputs with Fallbacks
                state.project = inputs.project ? inputs.project.value : "";
                state.width = (inputs.width ? parseFloat(inputs.width.value) : 600) || 600;
                state.depth = (inputs.depth ? parseFloat(inputs.depth.value) : 600) || 600;
                state.cover = (inputs.cover ? parseFloat(inputs.cover.value) : 40) || 40;
                state.mainSize = inputs.mainSize ? inputs.mainSize.value : "DB25";
                state.nx = (inputs.nx ? parseInt(inputs.nx.value) : 2) || 2;
                state.ny = (inputs.ny ? parseInt(inputs.ny.value) : 2) || 2;
                state.tieSize = inputs.tieSize ? inputs.tieSize.value : "DB10";
                state.sZone = (inputs.sZone ? parseFloat(inputs.sZone.value) : 75) || 75;
                state.sMid = (inputs.sMid ? parseFloat(inputs.sMid.value) : 200) || 200;

                // Update Calculated Fields
                const totalBars = 2 * state.nx + 2 * (state.ny - 2); 
                if(inputs.mainCountDisplay) inputs.mainCountDisplay.value = totalBars;

                // 2. Update Title Block (Values)
                const valTitle = inputs.titleVal ? inputs.titleVal.value : "";
                const valDate = inputs.dateVal ? inputs.dateVal.value : "";
                const valDrawn = inputs.drawnVal ? inputs.drawnVal.value : "";
                const valScale = inputs.scaleVal ? inputs.scaleVal.value : "";
                const valNote = inputs.noteVal ? inputs.noteVal.value : "";

                const elTbProject = document.getElementById('tb-project');
                const elTbTitle = document.getElementById('tb-title');
                const elTbDate = document.getElementById('tb-date');
                const elTbDrawn = document.getElementById('tb-drawn-val');
                const elTbScale = document.getElementById('tb-scale');
                const elTbNote = document.getElementById('tb-note');

                if (elTbProject) elTbProject.textContent = state.project.toUpperCase();
                if (elTbTitle) elTbTitle.textContent = valTitle.toUpperCase();
                if (elTbDate) elTbDate.textContent = valDate;
                if (elTbDrawn) elTbDrawn.textContent = valDrawn;
                if (elTbScale) elTbScale.textContent = valScale;
                if (elTbNote) elTbNote.textContent = `${totalBars}-${state.mainSize} ${valNote}`;

                // 3. Clear SVG
                svg.innerHTML = '';
                
                // 4. Add Defs
                addDefs();

                // 5. Draw Views
                drawSectionView();
                drawElevationView();
            } catch (err) {
                console.error("Error updating drawing:", err);
            }
        }


        function addDefs() {
            const defs = document.createElementNS("http://www.w3.org/2000/svg", "defs");
            defs.innerHTML = `
                <marker id="dot" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="5" markerHeight="5">
                    <circle cx="5" cy="5" r="3" fill="#00FFFF"/>
                </marker>
                <marker id="arrow" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
                    <path d="M0,0 L10,5 L0,10 z" fill="#00FFFF"/>
                </marker>
            `;
            svg.appendChild(defs);
        }

        // --- Drawing Helpers ---
        function createEl(type, attrs) {
            const el = document.createElementNS("http://www.w3.org/2000/svg", type);
            for (const [k, v] of Object.entries(attrs)) el.setAttribute(k, v);
            return el;
        }

        function drawSectionView() {
            const group = createEl('g', { id: 'section-view' });
            
            // Scale Factor: let's map input dimensions to drawing units
            // Assuming 1 unit = 1 pixel for simplicity in this ViewBox
            // Center the column at (200, 200) locally
            const startX = 50; 
            const startY = 50;
            // Scale: 600mm -> 300px => ratio = 0.5
            const scale = 0.5;
            const w = state.width * scale;
            const h = state.depth * scale;
            const cvr = state.cover * scale; // cover in dwg units

            // 1. Concrete Outline
            const concrete = createEl('rect', {
                x: startX, y: startY, width: w, height: h,
                class: 'concrete-outline'
            });
            group.appendChild(concrete);

            // 2. Main Stirrup
            // Inset by cover
            const stX = startX + cvr;
            const stY = startY + cvr;
            const stW = w - 2*cvr;
            const stH = h - 2*cvr;
            const r = 8; // corner radius

            // Complex path for stirrup with hooks
            // Simplified logic: Rect path + hooks
            // Corners: TL(stX, stY), TR(stX+stW, stY), BR(stX+stW, stY+stH), BL(stX, stY+stH)
            
            // Hook Length
            const hkL = 20; 
            
            let d = `M ${stX+15} ${stY} H ${stX+stW-r} A ${r} ${r} 0 0 1 ${stX+stW} ${stY+r} V ${stY+stH-r} A ${r} ${r} 0 0 1 ${stX+stW-r} ${stY+stH}`;
            // Hook BR (Inward)
            d += ` L ${stX+stW-hkL} ${stY+stH-hkL} M ${stX+stW-r} ${stY+stH}`; // Fake hook visually
            
            d += ` H ${stX+r} A ${r} ${r} 0 0 1 ${stX} ${stY+stH-r} V ${stY+r} A ${r} ${r} 0 0 1 ${stX+r} ${stY}`;
            // Hook TL
            d += ` L ${stX+hkL} ${stY+hkL}`;

            const stirrup = createEl('path', {
                d: d,
                fill: 'none', stroke: '#ffeb3b', 'stroke-width': 2
            });
            group.appendChild(stirrup);

            // 3. Main Bars
            // Calculate positions
            // X-spacing: (stW) / (nx - 1)
            // Y-spacing: (stH) / (ny - 1)
            const sx = stW / (state.nx - 1);
            const sy = stH / (state.ny - 1);
            
            const barGroup = createEl('g', { id: 'main-bars' });
            
            // Draw Top and Bottom rows
            for(let i=0; i<state.nx; i++) {
                const cx = stX + i*sx;
                // Top
                barGroup.appendChild(createEl('circle', { cx: cx, cy: stY, r: 8, class: 'main-bar' }));
                // Bottom
                barGroup.appendChild(createEl('circle', { cx: cx, cy: stY+stH, r: 8, class: 'main-bar' }));
            }
            // Draw Side rows (exclude corners)
            for(let j=1; j<state.ny-1; j++) {
                const cy = stY + j*sy;
                // Left
                barGroup.appendChild(createEl('circle', { cx: stX, cy: cy, r: 8, class: 'main-bar' }));
                // Right
                barGroup.appendChild(createEl('circle', { cx: stX+stW, cy: cy, r: 8, class: 'main-bar' }));
            }
            group.appendChild(barGroup);
            
            // 4. Cross Ties (Simplified Logic: Connect opposing bars if > 2x2)
            // Vertical Ties (connect top-bottom) for internal cols
            const tieGroup = createEl('g', { id: 'cross-ties', fill: 'none', stroke: '#ffeb3b', 'stroke-width': 2 });
            
            // Vertical Crossties (skip outer cols 0 and nx-1)
            for(let i=1; i<state.nx-1; i++) {
                 const cx = stX + i*sx;
                 const topY = stY + 10;
                 const botY = stY + stH - 10;
                 // Draw line with hooks
                 let path = `M ${cx-10} ${topY+10} L ${cx} ${topY} V ${botY} L ${cx+10} ${botY-10}`; // S-hook shape roughly
                 tieGroup.appendChild(createEl('path', { d: path }));
            }
             // Horizontal Crossties (skip outer rows 0 and ny-1)
             for(let j=1; j<state.ny-1; j++) {
                 const cy = stY + j*sy;
                 const leftX = stX + 10;
                 const rightX = stX + stW - 10;
                 let path = `M ${leftX+10} ${cy-10} L ${leftX} ${cy} H ${rightX} L ${rightX-10} ${cy+10}`;
                 tieGroup.appendChild(createEl('path', { d: path }));
            }
            group.appendChild(tieGroup);

            // 5. Labels & Dimensions (Dynamic positions)
            // Top Dimension - Width
            group.appendChild(createEl('line', { x1: startX, y1: startY-20, x2: startX+w, y2: startY-20, class: 'dim-line' })); // Main line
            group.appendChild(createEl('line', { x1: startX, y1: startY-25, x2: startX, y2: startY-15, class: 'dim-line' })); // L tick
            group.appendChild(createEl('line', { x1: startX+w, y1: startY-25, x2: startX+w, y2: startY-15, class: 'dim-line' })); // R tick
            // Text center
            const textW = createEl('text', { x: startX + w/2, y: startY-30, 'text-anchor': 'middle', class: 'label-text' });
            textW.textContent = state.width;
            group.appendChild(textW);

            // Side Dimension - Depth
            group.appendChild(createEl('line', { x1: startX-20, y1: startY, x2: startX-20, y2: startY+h, class: 'dim-line' })); 
            group.appendChild(createEl('line', { x1: startX-25, y1: startY, x2: startX-15, y2: startY, class: 'dim-line' })); 
            group.appendChild(createEl('line', { x1: startX-25, y1: startY+h, x2: startX-15, y2: startY+h, class: 'dim-line' })); 
            const textH = createEl('text', { 
                x: startX-30, y: startY + h/2, 'text-anchor': 'middle', 
                transform: `rotate(-90, ${startX-30}, ${startY + h/2})`, class: 'label-text' 
            });
            textH.textContent = state.depth;
            group.appendChild(textH);

            // Leader Lines & Text
            // Dog-leg style: angled line from element + horizontal line for text (engineering standard)
            
            // Rebar Label (Main Bars) - pointing to top-right bar
            const barPointX = stX + stW;  // Right side bar X
            const barPointY = stY;        // Top bar Y
            const barMidX = startX + w + 40;
            const barMidY = startY - 20;
            const barEndX = startX + w + 100;
            
            // Angled line from bar to midpoint
            group.appendChild(createEl('path', { 
                d: `M ${barPointX} ${barPointY} L ${barMidX} ${barMidY}`, 
                stroke:'#00FFFF', 'stroke-width':0.5, 'marker-start':'url(#arrow)' 
            }));
            // Horizontal line from midpoint
            group.appendChild(createEl('line', { 
                x1: barMidX, y1: barMidY, x2: barEndX, y2: barMidY, 
                stroke:'#00FFFF', 'stroke-width':0.5 
            }));
            const labelRebar = createEl('text', { x: barEndX + 5, y: barMidY + 5, class: 'label-text' });
            const total = (2*state.nx + 2*(state.ny-2));
            labelRebar.textContent = `${total}-${state.mainSize}`;
            group.appendChild(labelRebar);
            const subLabelRebar = createEl('text', { x: barEndX + 5, y: barMidY + 20, class: 'sub-label' });
            subLabelRebar.textContent = "Main Bars";
            group.appendChild(subLabelRebar);

            // Main Ties Label - pointing to stirrup right side
            const tiePointX = stX + stW;      // Stirrup right edge
            const tiePointY = stY + stH/2;    // Middle height
            const tieMidX = startX + w + 40;
            const tieMidY = startY + h/2 - 30;
            const tieEndX = startX + w + 100;
            
            group.appendChild(createEl('path', { 
                d: `M ${tiePointX} ${tiePointY} L ${tieMidX} ${tieMidY}`, 
                stroke:'#00FFFF', 'stroke-width':0.5, 'marker-start':'url(#arrow)' 
            }));
            group.appendChild(createEl('line', { 
                x1: tieMidX, y1: tieMidY, x2: tieEndX, y2: tieMidY, 
                stroke:'#00FFFF', 'stroke-width':0.5 
            }));
            const labelTie = createEl('text', { x: tieEndX + 5, y: tieMidY + 5, class: 'label-text' });
            labelTie.textContent = state.tieSize;
            group.appendChild(labelTie);
            const subLabelTie = createEl('text', { x: tieEndX + 5, y: tieMidY + 20, class: 'sub-label' });
            subLabelTie.textContent = "Main Ties";
            group.appendChild(subLabelTie);

            // Cross Ties Label - pointing to internal ties (if present)
            if (state.nx > 2 || state.ny > 2) {
                const crossPointX = stX + stW/2;  // Center of column
                const crossPointY = stY + stH/2;
                const crossMidX = startX + w + 40;
                const crossMidY = startY + h/2 + 30;
                const crossEndX = startX + w + 100;
                
                group.appendChild(createEl('path', { 
                    d: `M ${crossPointX} ${crossPointY} L ${crossMidX} ${crossMidY}`, 
                    stroke:'#00FFFF', 'stroke-width':0.5, 'marker-start':'url(#arrow)' 
                }));
                group.appendChild(createEl('line', { 
                    x1: crossMidX, y1: crossMidY, x2: crossEndX, y2: crossMidY, 
                    stroke:'#00FFFF', 'stroke-width':0.5 
                }));
                const labelCross = createEl('text', { x: crossEndX + 5, y: crossMidY + 5, class: 'label-text' });
                labelCross.textContent = state.tieSize;
                group.appendChild(labelCross);
                const subLabelCross = createEl('text', { x: crossEndX + 5, y: crossMidY + 20, class: 'sub-label' });
                subLabelCross.textContent = "Cross Ties";
                group.appendChild(subLabelCross);
            }

            // Cover Label
            // ชี้จากมุมบนซ้าย (Concrete Outline)
            group.appendChild(createEl('path', { d:`M ${startX} ${startY} L ${startX-40} ${startY-30}`, stroke:'#00FFFF', 'stroke-width':0.5, 'marker-start':'url(#dot)' }));
            group.appendChild(createEl('line', { x1: startX-40, y1: startY-30, x2: startX-100, y2: startY-30, stroke:'#00FFFF', 'stroke-width':0.5 }));
            const labelCover = createEl('text', { x: startX-100, y: startY-35, class: 'sub-label' });
            labelCover.textContent = `COVER ${state.cover}mm`;
            group.appendChild(labelCover);

            // View Title
            const title = createEl('text', { x: startX + w/2, y: startY + h + 60, 'text-anchor': 'middle', class: 'view-title' });
            title.textContent = "SECTION A-A";
            group.appendChild(title);

            svg.appendChild(group);
        }

        function drawElevationView() {
            const group = createEl('g', { id: 'elevation-view', transform: 'translate(700, 0)' });
            
            // Fixed illustrative height for elevation: 500px representing 5m
            const H = 500; 
            const W = 100; // Fixed visual width for simplicity
            const startX = 100;
            const startY = 20;

            // 1. Concrete
            group.appendChild(createEl('rect', { x: startX, y: startY, width: W, height: H, class: 'concrete-outline' }));
            
            // 2. Main Bars (Lines)
            group.appendChild(createEl('line', { x1: startX+15, y1: startY, x2: startX+15, y2: startY+H, stroke:'white', 'stroke-width':3 }));
            group.appendChild(createEl('line', { x1: startX+W-15, y1: startY, x2: startX+W-15, y2: startY+H, stroke:'white', 'stroke-width':3 }));
            // Center dashed
            group.appendChild(createEl('line', { x1: startX+W/2, y1: startY, x2: startX+W/2, y2: startY+H, stroke:'white', 'stroke-width':1, 'stroke-dasharray':'10 5', opacity:0.5 }));

            // Lap Splice Marker
            const spliceY = startY + H/2 + 20; // ประมาณกลางๆ ค่อนล่างนิดหน่อย
            const splicePath = `M ${startX+15} ${spliceY} L ${startX-10} ${spliceY} L ${startX-30} ${spliceY+20}`;
            group.appendChild(createEl('path', { d: splicePath, fill:'none', stroke:'white', 'stroke-width':1 }));
            const labelSplice = createEl('text', { x: startX-35, y: spliceY+25, 'text-anchor': 'end', class: 'sub-label' });
            labelSplice.textContent = "Lap Splice (50d)";
            group.appendChild(labelSplice);

            // 3. Stirrups Lines
            // Zone Ht ~ 1m -> 100px visual
            const zH = 100; 
            // Draw Zone Top
            const gTop = createEl('g', { stroke:'#ffeb3b', 'stroke-width':1.5 });
            for(let y=startY+10; y < startY+zH; y+=15) {
                gTop.appendChild(createEl('line', { x1: startX, y1: y, x2: startX+W, y2: y }));
            }
            group.appendChild(gTop);
            
            // Draw Middle
            const gMid = createEl('g', { stroke:'#ffeb3b', 'stroke-width':1.5 });
            for(let y=startY+zH+20; y < startY+H-zH; y+=40) { // wider visual spacing
                gMid.appendChild(createEl('line', { x1: startX, y1: y, x2: startX+W, y2: y }));
            }
            group.appendChild(gMid);

            // Draw Zone Bottom
            const gBot = createEl('g', { stroke:'#ffeb3b', 'stroke-width':1.5 });
            for(let y=startY+H-zH+10; y < startY+H; y+=15) {
                gBot.appendChild(createEl('line', { x1: startX, y1: y, x2: startX+W, y2: y }));
            }
            group.appendChild(gBot);


            // 4. Dimensions & Labels
            const dX = startX + W + 20;
            // Top Zone
            group.appendChild(createEl('line', { x1: dX, y1: startY, x2: dX, y2: startY+zH, class: 'dim-line' }));
            group.appendChild(createEl('text', { x: dX+10, y: startY + zH/2, class:'label-text', fill:'white' })).textContent = `@${state.sZone}`;
            group.appendChild(createEl('text', { x: dX+60, y: startY + zH/2, class:'label-text', fill:'#aaa' })).textContent = `(1000)`;

            // Mid Zone
            group.appendChild(createEl('line', { x1: dX, y1: startY+zH, x2: dX, y2: startY+H-zH, class: 'dim-line' }));
            group.appendChild(createEl('text', { x: dX+10, y: startY + H/2, class:'label-text', fill:'white' })).textContent = `@${state.sMid}`;
            group.appendChild(createEl('text', { x: dX+60, y: startY + H/2, class:'label-text', fill:'#aaa' })).textContent = `(3000)`;

             // Bot Zone
             group.appendChild(createEl('line', { x1: dX, y1: startY+H-zH, x2: dX, y2: startY+H, class: 'dim-line' }));
             group.appendChild(createEl('text', { x: dX+10, y: startY + H - zH/2, class:'label-text', fill:'white' })).textContent = `@${state.sZone}`;
             group.appendChild(createEl('text', { x: dX+60, y: startY + H - zH/2, class:'label-text', fill:'#aaa' })).textContent = `(1000)`;

             // Ticks
             [startY, startY+zH, startY+H-zH, startY+H].forEach(y => {
                 group.appendChild(createEl('line', { x1: dX-5, y1: y, x2: dX+5, y2:y, stroke:'white' }));
             });

            // View Title
            const title = createEl('text', { x: startX + W/2, y: startY + H + 60, 'text-anchor': 'middle', class: 'view-title' });
            title.textContent = "ELEVATION VIEW";
            group.appendChild(title);

            svg.appendChild(group);
        }

        // --- Export SVG Function ---
        function exportSVG() {
            // Get the SVG element
            const svgElement = document.getElementById('main-svg');
            
            // Clone the SVG to avoid modifying the original
            const clonedSvg = svgElement.cloneNode(true);
            
            // Get computed styles for colors
            const blueprintBg = getComputedStyle(document.documentElement).getPropertyValue('--blueprint-bg').trim() || '#0a244d';
            const blueprintGrid = getComputedStyle(document.documentElement).getPropertyValue('--blueprint-grid').trim() || '#1c3b6b';
            
            // Create background and grid pattern
            const viewBox = clonedSvg.getAttribute('viewBox').split(' ').map(Number);
            const [vbX, vbY, vbW, vbH] = viewBox;
            
            // Create defs for pattern and insert at the beginning
            let defs = clonedSvg.querySelector('defs');
            if (!defs) {
                defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
                clonedSvg.insertBefore(defs, clonedSvg.firstChild);
            }
            
            // Add grid pattern
            const pattern = document.createElementNS('http://www.w3.org/2000/svg', 'pattern');
            pattern.setAttribute('id', 'grid');
            pattern.setAttribute('width', '40');
            pattern.setAttribute('height', '40');
            pattern.setAttribute('patternUnits', 'userSpaceOnUse');
            
            const gridPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            gridPath.setAttribute('d', 'M 40 0 L 0 0 0 40');
            gridPath.setAttribute('fill', 'none');
            gridPath.setAttribute('stroke', blueprintGrid);
            gridPath.setAttribute('stroke-width', '1');
            pattern.appendChild(gridPath);
            defs.appendChild(pattern);
            
            // Create background rect with grid
            const bgGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            bgGroup.setAttribute('id', 'background');
            
            // Solid background
            const bgRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            bgRect.setAttribute('x', vbX - 50);
            bgRect.setAttribute('y', vbY - 50);
            bgRect.setAttribute('width', vbW + 100);
            bgRect.setAttribute('height', vbH + 100);
            bgRect.setAttribute('fill', blueprintBg);
            bgGroup.appendChild(bgRect);
            
            // Grid overlay
            const gridRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            gridRect.setAttribute('x', vbX - 50);
            gridRect.setAttribute('y', vbY - 50);
            gridRect.setAttribute('width', vbW + 100);
            gridRect.setAttribute('height', vbH + 100);
            gridRect.setAttribute('fill', 'url(#grid)');
            bgGroup.appendChild(gridRect);
            
            // Insert background at the beginning (after defs)
            clonedSvg.insertBefore(bgGroup, defs.nextSibling);
            
            // --- Add Title Block to SVG ---
            const titleBlockGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            titleBlockGroup.setAttribute('id', 'title-block');
            titleBlockGroup.setAttribute('transform', `translate(${vbX + vbW - 350}, ${vbY + vbH - 180})`);
            
            // Title block background
            const tbBg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            tbBg.setAttribute('x', '0');
            tbBg.setAttribute('y', '0');
            tbBg.setAttribute('width', '320');
            tbBg.setAttribute('height', '160');
            tbBg.setAttribute('fill', 'rgba(10, 36, 77, 0.95)');
            tbBg.setAttribute('stroke', 'white');
            tbBg.setAttribute('stroke-width', '2');
            titleBlockGroup.appendChild(tbBg);
            
            // Get values from inputs
            const projectName = inputs.project ? inputs.project.value.toUpperCase() : 'PROJECT';
            const titleVal = inputs.titleVal ? inputs.titleVal.value.toUpperCase() : '';
            const dateVal = inputs.dateVal ? inputs.dateVal.value : '';
            const drawnVal = inputs.drawnVal ? inputs.drawnVal.value : '';
            const scaleVal = inputs.scaleVal ? inputs.scaleVal.value : '';
            const noteVal = inputs.noteVal ? inputs.noteVal.value : '';
            const totalBars = 2 * state.nx + 2 * (state.ny - 2);
            
            // Project Title
            const projectText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            projectText.setAttribute('x', '15');
            projectText.setAttribute('y', '25');
            projectText.setAttribute('fill', '#ffeb3b');
            projectText.setAttribute('font-size', '14');
            projectText.setAttribute('font-weight', 'bold');
            projectText.setAttribute('font-family', 'Courier New, monospace');
            projectText.textContent = `PROJECT: ${projectName}`;
            titleBlockGroup.appendChild(projectText);
            
            // Separator line
            const sepLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            sepLine.setAttribute('x1', '10');
            sepLine.setAttribute('y1', '35');
            sepLine.setAttribute('x2', '310');
            sepLine.setAttribute('y2', '35');
            sepLine.setAttribute('stroke', 'white');
            sepLine.setAttribute('stroke-width', '1');
            titleBlockGroup.appendChild(sepLine);
            
            // Helper function for text rows
            function addTextRow(label, value, y) {
                const labelText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                labelText.setAttribute('x', '15');
                labelText.setAttribute('y', y);
                labelText.setAttribute('fill', 'white');
                labelText.setAttribute('font-size', '11');
                labelText.setAttribute('font-weight', 'bold');
                labelText.setAttribute('font-family', 'Courier New, monospace');
                labelText.textContent = label + ':';
                titleBlockGroup.appendChild(labelText);
                
                const valText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                valText.setAttribute('x', '90');
                valText.setAttribute('y', y);
                valText.setAttribute('fill', 'white');
                valText.setAttribute('font-size', '11');
                valText.setAttribute('font-family', 'Courier New, monospace');
                valText.textContent = value;
                titleBlockGroup.appendChild(valText);
            }
            
            addTextRow('DWG TITLE', titleVal, 52);
            addTextRow('DATE', dateVal, 68);
            addTextRow('DRAWN BY', drawnVal, 84);
            addTextRow('SCALE', scaleVal, 100);
            addTextRow('NOTE', `${totalBars}-${state.mainSize} ${noteVal}`, 116);
            
            clonedSvg.appendChild(titleBlockGroup);
            
            // Add required namespaces and styling
            clonedSvg.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
            clonedSvg.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink');
            
            // Add embedded styles
            const styleEl = document.createElementNS('http://www.w3.org/2000/svg', 'style');
            styleEl.textContent = `
                .concrete-outline { fill: none; stroke: white; stroke-width: 2; }
                .stirrup { fill: none; stroke: #ffeb3b; stroke-width: 2; }
                .main-bar { fill: white; stroke: none; }
                .dim-line { stroke: white; stroke-width: 0.5; }
                .label-text { fill: white; font-size: 14px; font-weight: bold; font-family: 'Courier New', monospace; }
                .sub-label { fill: #aaaaaa; font-size: 12px; font-family: 'Courier New', monospace; }
                .view-title { font-size: 20px; font-weight: bold; text-decoration: underline; fill: white; font-family: 'Courier New', monospace; }
            `;
            defs.appendChild(styleEl);
            
            // Serialize to string
            const serializer = new XMLSerializer();
            let svgString = serializer.serializeToString(clonedSvg);
            
            // Add XML declaration
            svgString = '<?xml version="1.0" encoding="UTF-8"?>\n' + svgString;
            
            // Create download link
            const blob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            const fileName = `${inputs.titleVal ? inputs.titleVal.value.replace(/\s+/g, '_') : 'column_reinforcement'}_${new Date().toISOString().slice(0,10)}.svg`;
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Cleanup
            URL.revokeObjectURL(url);
        }

        // Start
        init();
    </script>
</body>
</html>